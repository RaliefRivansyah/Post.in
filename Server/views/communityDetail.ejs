<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>r/<%= community.name %></title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="/posts">My Blog</a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/posts">Posts</a>
                    <a class="nav-link" href="/communities">Communities</a>
                    <a class="nav-link" href="/profile">Profile</a>
                    <a class="nav-link" href="/auth/logout">Logout</a>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Community Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <% if (community.iconUrl) { %>
                            <img
                                src="<%= community.iconUrl %>"
                                alt="<%= community.name %>"
                                class="rounded-circle me-3"
                                width="80"
                                height="80" />
                            <% } else { %>
                            <div
                                class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                                style="width: 80px; height: 80px; font-size: 2rem">
                                <%= community.name.charAt(0).toUpperCase() %>
                            </div>
                            <% } %>
                            <div>
                                <h2 class="mb-1"><%= community.name %></h2>
                                <p class="text-muted mb-1"><%= community.description %></p>
                                <small class="text-muted">
                                    Created by <%= community.Creator.username %> ‚Ä¢ <%= community.Members ? community.Members.length : 0 %>
                                    members
                                </small>
                            </div>
                        </div>
                        <% const isMember = community.Members && community.Members.some(m => m.id === user.id) %> <% if (isMember) { %>
                        <form action="/communities/<%= community.id %>/leave" method="POST">
                            <button type="submit" class="btn btn-outline-danger">Leave Community</button>
                        </form>
                        <% } else { %>
                        <form action="/communities/<%= community.id %>/join" method="POST">
                            <button type="submit" class="btn btn-primary">Join Community</button>
                        </form>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Create Post Button (only for members) -->
            <% if (isMember) { %>
            <div class="mb-3">
                <a href="/posts/new?communityId=<%= community.id %>" class="btn btn-primary">Create Post in r/<%= community.name %></a>
            </div>
            <% } %>

            <!-- Posts in this community -->
            <h4 class="mb-3">Posts</h4>
            <% if (posts && posts.length > 0) { %> <% posts.forEach(post => { %>
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-start mb-2">
                        <% if (post.User.Profile && post.User.Profile.avatarUrl) { %>
                        <img
                            src="<%= post.User.Profile.avatarUrl %>"
                            alt="<%= post.User.username %>"
                            class="rounded-circle me-2"
                            width="32"
                            height="32" />
                        <% } else { %>
                        <div
                            class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2"
                            style="width: 32px; height: 32px; font-size: 0.9rem">
                            <%= post.User.username.charAt(0).toUpperCase() %>
                        </div>
                        <% } %>
                        <div>
                            <small class="text-muted">
                                Posted by <%= post.User.username %> ‚Ä¢ <%= new Date(post.createdAt).toLocaleDateString() %>
                            </small>
                        </div>
                    </div>
                    <h5 class="card-title">
                        <a href="/posts/<%= post.id %>" class="text-decoration-none text-dark"><%= post.title %></a>
                    </h5>
                    <p class="card-text"><%= post.content %></p>
                    <div class="d-flex gap-3">
                        <form action="/posts/<%= post.id %>/like" method="POST" style="display: inline">
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                üëç <%= post.Likes ? post.Likes.length : 0 %>
                            </button>
                        </form>
                        <a href="/posts/<%= post.id %>" class="btn btn-sm btn-outline-secondary">
                            üí¨ <%= post.Comments ? post.Comments.length : 0 %> Comments
                        </a>
                    </div>
                </div>
            </div>
            <% }) %> <% } else { %>
            <p class="text-muted">No posts in this community yet. Be the first to post!</p>
            <% } %>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
